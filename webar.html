<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebAR Caneca DL - Vídeo Teste</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <link rel="stylesheet" href="webar.css">
</head>
<body>

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true">
    <!-- marcador Hiro -->
    <a-marker preset="hiro">
  <a-box position="0 0.5 0" material="color:red"></a-box>
</a-marker>

    <a-entity camera></a-entity>

    <a-image id="videoResource"
           src="https://cdn.pixabay.com/vimeo/341999025/sunset-23318.mp4?width=640&hash=5a23e1f7ef90b2ad2b5b3777e5ee0642a3fbb52c"
           autoplay muted loop playsinline webkit-playsinline crossorigin="anonymous"
           style="display:none"></a-image>
    <a-entity id="mediaHolder"></a-entity>
  </a-scene>

  <div class="hint">
    Aponte para o marcador <strong>Hiro</strong>. Baixe/imprima: 
    <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank" rel="noopener" class="hiro-link">hiro.png</a>
  </div>

  <div id="overlayPlay" class="overlay-play" title="Tocar vídeo">
    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
  </div>

<script>
const videoResource = document.getElementById('videoResource');
const mediaHolder = document.getElementById('mediaHolder');
const overlayPlay = document.getElementById('overlayPlay');

function mountVideo() {
  const aVideo = document.createElement('a-video');
  aVideo.setAttribute('src','#videoResource');
  aVideo.setAttribute('width','1.6');
  videoResource.onloadedmetadata = () => {
    const ratio = videoResource.videoHeight / videoResource.videoWidth;
    const height = Math.min(1.6 * ratio,1.2);
    aVideo.setAttribute('height',String(height));
  };
  aVideo.setAttribute('position','0 0 0');
  aVideo.setAttribute('rotation','0 0 0');
  mediaHolder.appendChild(aVideo);

  videoResource.play().catch(()=>{
    overlayPlay.style.display = 'block';
  });
}

overlayPlay.addEventListener('click', ()=>{
  videoResource.muted = false;
  videoResource.play().catch(()=>{});
  overlayPlay.style.display = 'none';
});

document.addEventListener('DOMContentLoaded', mountVideo);
document.addEventListener('touchstart', function onFirstTouch(){
  if (videoResource.paused) videoResource.play().catch(()=>{});
  document.removeEventListener('touchstart', onFirstTouch);
},{passive:true});
</script>

</body>
</html>

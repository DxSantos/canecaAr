<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>WebAR - Vídeo / Foto (A-Frame + AR.js)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js (aframe build) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .ui {
      position: fixed;
      z-index: 9999;
      left: 8px;
      top: 8px;
      background: rgba(0,0,0,0.45);
      padding: 8px 10px;
      border-radius: 8px;
      backdrop-filter: blur(4px);
      display:flex;
      gap:8px;
      align-items:center;
      color:#fff;
      font-size:14px;
    }
    .btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.06);
      padding:6px 10px;
      border-radius:6px;
      color:#fff;
      cursor:pointer;
    }
    .hint {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
    }
    /* overlay play for video */
    .overlay-play{
      position: absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.45);
      border-radius: 999px;
      padding:18px;
      display:none;
      z-index:10000;
    }
    .overlay-play.show{display:block}
    .overlay-play svg{width:36px;height:36px;fill:#fff}
  </style>
</head>
<body>

  <div class="ui">
    <div id="modeLabel">Carregando...</div>
    <button id="openMarker" class="btn">Abrir marcador (Hiro)</button>
    <button id="openFull" class="btn">Abrir em tela</button>
  </div>

  <div id="overlayPlay" class="overlay-play" title="Tocar vídeo">
    <!-- ícone play -->
    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
  </div>

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
    <!-- marcador HIRO -->
    <a-marker preset="hiro" id="marker">
      <!-- target entity: imagem ou vídeo será inserido dinamicamente -->
      <a-entity id="mediaHolder" rotation="-90 0 0"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>

    <!-- elementos de mídia usados como recursos -->
    <img id="imgResource" src="" crossorigin="anonymous" style="display:none;">
    <video id="videoResource" src="" crossorigin="anonymous" playsinline webkit-playsinline muted loop style="display:none"></video>
  </a-scene>

  <div class="hint">Aponte para o marcador <strong>Hiro</strong>. Baixe/imprima: <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank" style="color:#9cf">hiro.png</a></div>

<script>
/*
  Uso:
    /webar.html?mode=image&src=https://site.com/minhaimagem.jpg
    /webar.html?mode=video&src=https://site.com/meuvideo.mp4

  Notas:
  - Para autoplay em vídeo no mobile, alguns navegadores exigem interação do usuário (touch).
  - Se o vídeo estiver em outro domínio, verifique CORS (Access-Control-Allow-Origin).
*/

function qs(key, fallback='') {
  const u = new URL(window.location.href);
  return u.searchParams.get(key) || fallback;
}

const mode = qs('mode', 'image'); // 'image' ou 'video'
const src  = qs('src', '').trim();

// defaults públicos (se não passar src)
const defaultImage = 'https://cdn.pixabay.com/photo/2023/03/16/10/54/mountains-7856204_1280.jpg';
const defaultVideo = 'https://cdn.pixabay.com/vimeo/341999025/sunset-23318.mp4?width=640&hash=5a23e1f7ef90b2ad2b5b3777e5ee0642a3fbb52c';

const modeLabel = document.getElementById('modeLabel');
modeLabel.textContent = (mode === 'video') ? 'Modo: VÍDEO' : 'Modo: IMAGEM';

const imgResource = document.getElementById('imgResource');
const videoResource = document.getElementById('videoResource');
const mediaHolder = document.getElementById('mediaHolder');
const overlayPlay = document.getElementById('overlayPlay');

const finalSrc = src || (mode === 'video' ? defaultVideo : defaultImage);

// função para limpar holder
function clearHolder(){
  while(mediaHolder.firstChild) mediaHolder.removeChild(mediaHolder.firstChild);
}

// monta imagem
function mountImage(url){
  clearHolder();
  imgResource.src = url;
  imgResource.onload = () => {
    // criar plano com a textura
    const plane = document.createElement('a-plane');
    plane.setAttribute('width', 1.2);
    // ajusta altura mantendo proporção da imagem
    const ratio = imgResource.naturalHeight / imgResource.naturalWidth;
    const height = Math.min(1.2 * ratio, 1.5);
    plane.setAttribute('height', height);
    plane.setAttribute('material', `src: #imgResource; transparent:true`);
    plane.setAttribute('position', '0 0 0');
    plane.setAttribute('rotation', '-90 0 0');
    mediaHolder.appendChild(plane);
  };
  imgResource.onerror = () => {
    alert('Erro ao carregar a imagem. Verifique a URL (CORS ou caminho inválido).');
  };
}

// monta vídeo
function mountVideo(url){
  clearHolder();
  videoResource.src = url;
  videoResource.setAttribute('playsinline', '');
  videoResource.setAttribute('webkit-playsinline', '');
  videoResource.muted = true; // reprodução automática só com muted em muitos mobiles
  videoResource.loop = true;
  // adiciona a-video que usa o elemento <video> como textura
  const aVideo = document.createElement('a-video');
  aVideo.setAttribute('src', '#videoResource');
  aVideo.setAttribute('width', '1.6');

  // vamos tentar obter proporção do vídeo assim que metadata carregar
  videoResource.onloadedmetadata = () => {
    const ratio = videoResource.videoHeight / videoResource.videoWidth;
    const height = Math.min(1.6 * ratio, 1.2);
    aVideo.setAttribute('height', String(height));
  };

  aVideo.setAttribute('position', '0 0 0');
  aVideo.setAttribute('rotation', '-90 0 0');

  // se autoplay bloqueado, mostramos overlay para o usuário tocar
  videoResource.onplay = () => overlayPlay.classList.remove('show');
  videoResource.onpause = () => overlayPlay.classList.add('show');

  mediaHolder.appendChild(aVideo);

  // tenta autoplay (pode falhar sem interação)
  videoResource.play().catch(()=>{
    // exibe overlay para o usuário tocar
    overlayPlay.classList.add('show');
  });
  videoResource.onerror = () => {
    alert('Erro ao carregar o vídeo. Verifique a URL (CORS ou caminho inválido) e formato (mp4 recomendado).');
  };
}

// inicializa de acordo com mode
if (mode === 'video') {
  mountVideo(finalSrc);
} else {
  mountImage(finalSrc);
}

// botões UI
document.getElementById('openMarker').addEventListener('click', () => {
  alert('Imprima/mostre o marcador Hiro e aponte a câmera para ele.\n\nBaixe: https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png');
});

// abrir em nova aba (puro teste)
document.getElementById('openFull').addEventListener('click', () => {
  window.open(window.location.href, '_blank');
});

// overlay play handler (tocar video)
overlayPlay.addEventListener('click', () => {
  if (videoResource.src) {
    videoResource.muted = false; // se quiser permitir som, remova ou controle
    videoResource.play().catch(()=>{});
    overlayPlay.classList.remove('show');
  }
});

// se o modo for video, permita tocar com primeiro toque na tela (útil mobile)
document.addEventListener('touchstart', function onFirstTouch(){
  if (mode === 'video' && videoResource && videoResource.paused) {
    videoResource.play().catch(()=>{});
  }
  document.removeEventListener('touchstart', onFirstTouch);
}, {passive:true});

</script>
</body>
</html>
